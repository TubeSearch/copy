<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Cross-Device Clipboard (Chunked)</title>
<meta name="viewport" content="width=device-width,initial-scale=1">
<style>
body{font-family:system-ui;background:#111;color:#eee;padding:30px;text-align:center;}
h1{font-size:1.2rem;margin-bottom:10px;}
input,textarea{width:90%;max-width:500px;background:#222;color:#eee;border:1px solid #444;border-radius:8px;padding:8px;margin:5px 0;}
button{background:#8b5cf6;border:none;color:#fff;padding:8px 15px;border-radius:8px;cursor:pointer;margin-top:6px;}
.item{display:flex;justify-content:space-between;align-items:center;background:#222;margin:6px auto;padding:10px;border-radius:8px;max-width:500px;}
.copy{background:#444;}
</style>
</head>
<body>
<h1>ðŸ“‹ Cross-Device Clipboard</h1>
<input id="title" placeholder="Title"><br>
<textarea id="content" placeholder="Paste content here..."></textarea><br>
<button id="saveBtn">Save</button>
<div id="status"></div>
<h3>Board</h3>
<div id="board"></div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
import { getFirestore, collection, addDoc, setDoc, doc, query, orderBy, onSnapshot, getDocs } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyCmvpDUkWuX8jfz6uA5N0i7OgwqXwzQw_M",
  authDomain: "copyandpaste-fd810.firebaseapp.com",
  projectId: "copyandpaste-fd810",
};
const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

const MAX_CHUNK = 900000; // ~900KB per chunk
const titleEl = document.getElementById("title");
const contentEl = document.getElementById("content");
const statusEl = document.getElementById("status");
const boardEl = document.getElementById("board");

async function saveClip() {
  const title = titleEl.value.trim() || "(untitled)";
  const content = contentEl.value;
  if (!content) return (statusEl.textContent = "No content!");
  statusEl.textContent = "Saving...";

  try {
    // create clip doc
    const clipRef = await addDoc(collection(db, "clips"), {
      title,
      created: Date.now(),
      parts: Math.ceil(content.length / MAX_CHUNK)
    });

    // split into chunks
    const partCol = collection(db, "clips", clipRef.id, "chunks");
    for (let i = 0; i < content.length; i += MAX_CHUNK) {
      const chunk = content.slice(i, i + MAX_CHUNK);
      const index = String(i / MAX_CHUNK);
      await setDoc(doc(partCol, index), { data: chunk });
    }

    statusEl.textContent = "Saved âœ…";
    titleEl.value = "";
    contentEl.value = "";
  } catch (err) {
    console.error(err);
    statusEl.textContent = "Error saving! Check console.";
  }
}

document.getElementById("saveBtn").onclick = saveClip;

// Load board
onSnapshot(query(collection(db, "clips"), orderBy("created", "desc")), async (snap) => {
  boardEl.innerHTML = "";
  snap.forEach(docSnap => {
    const clip = docSnap.data();
    const row = document.createElement("div");
    row.className = "item";
    row.innerHTML = `<span>${clip.title}</span><button class="copy">Copy</button>`;

row.querySelector(".copy").onclick = async () => {
  statusEl.textContent = "Loading...";
  try {
    const chunksRef = collection(db, "clips", docSnap.id, "chunks");
    const partsSnap = await getDocs(chunksRef);
    if (partsSnap.empty) throw new Error("No chunks found for this clip.");

    const chunks = [];
    partsSnap.forEach(p => chunks.push({ i: Number(p.id), d: p.data().data }));
    chunks.sort((a, b) => a.i - b.i);
    const full = chunks.map(c => c.d).join("");

    try {
      await navigator.clipboard.writeText(full);
      statusEl.textContent = "Copied âœ…";
    } catch (clipErr) {
      console.warn("Clipboard write failed, showing fallback box:", clipErr);
      statusEl.textContent = "Clipboard blocked â€” copy manually â†“";

      let fallback = document.getElementById("fallbackCopy");
      if (!fallback) {
        fallback = document.createElement("pre");
        fallback.id = "fallbackCopy";
        fallback.style.whiteSpace = "pre-wrap";
        fallback.style.overflow = "auto";
        fallback.style.height = "3em"; // exactly 2 lines
        fallback.style.lineHeight = "1.5em";
        fallback.style.marginTop = "6px";
        fallback.style.border = "1px solid #444";
        fallback.style.padding = "6px";
        fallback.style.borderRadius = "6px";
        fallback.style.background = "#222"; // dark gray
        fallback.style.color = "#fff"; // white text
        fallback.style.fontFamily = "monospace";
        fallback.style.fontSize = "0.9rem";
        document.body.appendChild(fallback);
      }
      fallback.textContent = full;
    }
  } catch (err) {
    console.error("Copy failed:", err);
    statusEl.textContent = "âŒ " + (err.message || "Error loading or copying");
  } finally {
    setTimeout(() => {
      if (statusEl.textContent.startsWith("Copied")) statusEl.textContent = "";
    }, 4000);
  }
};

    boardEl.appendChild(row);
  });
});
</script>
</body>
</html>
